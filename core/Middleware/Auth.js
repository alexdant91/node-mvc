"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}require("dotenv").config();var _process$env=process.env,APP_KEY=_process$env.APP_KEY,APP_NAME=_process$env.APP_NAME,jwt=require("jsonwebtoken"),Database=require("../Database"),_require=require("../Helpers/models"),getModelExcludeString=_require.getModelExcludeString,Middleware=function a(){var b=this;(0,_classCallCheck2["default"])(this,a),(0,_defineProperty2["default"])(this,"setupToken",function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{expiresIn:void 0,issuer:void 0};return c.expiresIn||(c.expiresIn="2days"),c.issuer||(c.issuer=b._app_name),b._tokenPayload=a,b._tokenOptions=c,b._isSetupDone=!0,b}),(0,_defineProperty2["default"])(this,"signToken",function(a,c){var d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;delete a.body.payload.password;var e=a.body.payload;if(e){if(b.setupToken(e),b._isSetupDone){var f=jwt.sign(b._tokenPayload,b._app_key,{expiresIn:b._tokenOptions.expiresIn,issuer:b._tokenOptions.issuer});return b._tokenApp=f,d?(a.token=f,d()):c.status(200).json({token:f})}return debug.danger("You need to call `setupToken` method before processing token."),c.status(500).json({error:"Internal Server Error."})}return debug.danger("Missing required field `payload` on request. It must contain token payload to sign."),c.status(500).json({error:"Missing required field `payload` on request. It must contain token payload to sign."})}),(0,_defineProperty2["default"])(this,"verifyToken",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(c,d,e){var f,g,h,i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c.headers.authorization){a.next=3;break}return debug.danger("Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."),a.abrupt("return",d.status(500).json({error:"Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."}));case 3:if(f=c.headers.authorization.split("Bearer ")[1],!f){a.next=26;break}return a.prev=5,g=jwt.verify(f,b._app_key),h=new Database("User"),i=getModelExcludeString("User"),a.next=11,h.findOne({_id:g._id},i);case 11:if(j=a.sent,null==j){a.next=18;break}return c.user=_objectSpread({},j),c.decodedToken=g,a.abrupt("return",e());case 18:return debug.danger("You are not authorize. Expired or invalid token."),a.abrupt("return",d.status(400).json({error:"You are not authorize. Expired or invalid token."}));case 20:a.next=26;break;case 22:return a.prev=22,a.t0=a["catch"](5),debug.danger(a.t0.message),a.abrupt("return",d.status(400).json({error:"You are not authorize. Expired or invalid token."}));case 26:return debug.danger("Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."),a.abrupt("return",d.status(500).json({error:"Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."}));case 28:case"end":return a.stop();}},a,null,[[5,22]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"decodeToken",function(a,b,c){if(!a.headers.authorization)return debug.danger("Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."),b.status(500).json({error:"Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."});var d=a.headers.authorization.split("Bearer ")[1];if(d)try{var e=jwt.decode(d);return a.decodedToken=e,c()}catch(a){return debug.danger(a.message),b.status(500).json({error:a.message})}return debug.danger("Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."),b.status(500).json({error:"Missing required field `Authorization` on request headers. It must contain `Bearer {token}`."})}),this._app_key=APP_KEY,this._app_name=APP_NAME,this._tokenApp=null,this._isSetupDone=!1,this._tokenPayload,this._tokenOptions};module.exports=Middleware;