"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var Database=require("../../Database"),Cache=require("../../../cache/Cache"),bcrypt=require("bcryptjs"),Models=function a(b){var c=this;(0,_classCallCheck2["default"])(this,a),(0,_defineProperty2["default"])(this,"getUserToken",function(a){return!!a.headers.authorization&&a.headers.authorization.split("Bearer ")[1]}),(0,_defineProperty2["default"])(this,"findById",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(e=2<n.length&&void 0!==n[2]?n[2]:void 0,f=c.Models,g=f[c.modelName],h=b.params.id||b.body.id||b.query.id||void 0,i=!!b.decodedToken&&b.decodedToken,j={_id:h},i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),!h){a.next=25;break}return l=0<c.fieldsToExclude.length?"-".concat(c.fieldsToExclude.join(" -")):null,a.prev=9,a.next=12,g.findOne(j,l,{lean:!0});case 12:if(m=a.sent,!e){a.next=16;break}return b[c.modelName.toLowerCase()]=m,a.abrupt("return",e());case 16:d.status(200).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),m)),a.next=23;break;case 19:a.prev=19,a.t0=a["catch"](9),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 23:a.next=27;break;case 25:debug.danger("Missing required field `id` on `findOne` model. You can provide it on request body or query."),d.status(500).json({error:"Missing required field `id` on `findOne` model. You can provide it on request body or query."});case 27:case"end":return a.stop();}},a,null,[[9,19]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"findOne",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=2<n.length&&void 0!==n[2]?n[2]:void 0,f=b.body.find||{},g=c.Models,h=g[c.modelName],i=!!b.decodedToken&&b.decodedToken,j=_objectSpread({},f),i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),a.prev=7,l=0<c.fieldsToExclude.length?"-".concat(c.fieldsToExclude.join(" -")):null,a.next=11,h.findOne(j,l,{lean:!0});case 11:if(m=a.sent,!e){a.next=15;break}return b[c.modelName.toLowerCase()]=m,a.abrupt("return",e());case 15:d.status(200).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),m)),a.next=22;break;case 18:a.prev=18,a.t0=a["catch"](7),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 22:case"end":return a.stop();}},a,null,[[7,18]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"find",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=2<n.length&&void 0!==n[2]?n[2]:void 0,f=b.body.find||{},g=c.Models,h=g[c.modelName],i=!!b.decodedToken&&b.decodedToken,j=_objectSpread({},f),i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),a.prev=7,l=0<c.fieldsToExclude.length?"-".concat(c.fieldsToExclude.join(" -")):null,a.next=11,h.find(j,l,{lean:!0});case 11:if(m=a.sent,!e){a.next=15;break}return b[c.modelName.toLowerCase()]=m,a.abrupt("return",e());case 15:d.status(200).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),m)),a.next=22;break;case 18:a.prev=18,a.t0=a["catch"](7),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 22:case"end":return a.stop();}},a,null,[[7,18]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"findAll",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=2<t.length&&void 0!==t[2]?t[2]:void 0,f={saveCache:b.saveCache?b.saveCache:{save:!1}},f.saveCache.save&&void 0===f.saveCache.refresh&&(f.saveCache.refresh=!0),f.saveCache.save&&void 0===f.saveCache.refreshInterval&&(f.saveCache.refreshInterval=86400000),g=c.Models,h=g[c.modelName],i=!!b.decodedToken&&b.decodedToken,j={},i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),a.prev=9,l=0<c.fieldsToExclude.length?"-".concat(c.fieldsToExclude.join(" -")):null,a.next=13,h.find(j,l,{lean:!0});case 13:if(m=a.sent,!(f&&f.saveCache.save)){a.next=32;break}if(n=f.saveCache,o=n.key,p=n.refresh,q=n.refreshInterval,!p){a.next=28;break}if(r=Cache.get(["private","timers",o]),!(r&&r.lastUpdate+q>Date.now())){a.next=23;break}return a.next=21,Cache.set(o,(0,_defineProperty2["default"])({},c.modelName.toLowerCase(),(0,_toConsumableArray2["default"])(m)));case 21:a.next=26;break;case 23:if(r){a.next=26;break}return a.next=26,Cache.set(o,(0,_defineProperty2["default"])({},c.modelName.toLowerCase(),(0,_toConsumableArray2["default"])(m)));case 26:a.next=32;break;case 28:if(s=Cache.get(o),s){a.next=32;break}return a.next=32,Cache.set(o,(0,_defineProperty2["default"])({},c.modelName.toLowerCase(),(0,_toConsumableArray2["default"])(m)));case 32:if(!e){a.next=35;break}return b[c.modelName.toLowerCase()]=m,a.abrupt("return",e());case 35:d.status(200).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),m)),a.next=42;break;case 38:a.prev=38,a.t0=a["catch"](9),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 42:case"end":return a.stop();}},a,null,[[9,38]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"create",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=2<n.length&&void 0!==n[2]?n[2]:void 0,c.fieldsToHash.forEach(function(a){b.body.hasOwnProperty(a)&&(b.body[a]=bcrypt.hashSync(b.body[a],12))}),f=b.body,g=c.Models,h=g[c.modelName],i=!!b.decodedToken&&b.decodedToken,j=_objectSpread({},f),i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),a.prev=8,l=c.fieldsToExclude,a.next=12,new h(j).save();case 12:if(m=a.sent,l.forEach(function(a){return delete m[a]}),!e){a.next=17;break}return b[c.modelName.toLowerCase()]=m,a.abrupt("return",e());case 17:d.status(201).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),m)),a.next=24;break;case 20:a.prev=20,a.t0=a["catch"](8),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 24:case"end":return a.stop();}},a,null,[[8,20]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"update",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(e=2<q.length&&void 0!==q[2]?q[2]:void 0,c.fieldsToHash.forEach(function(a){b.body.hasOwnProperty(a)&&(b.body[a]=bcrypt.hashSync(b.body[a],12))}),f=b.body,g=c.Models,h=g[c.modelName],i=b.params.id||b.body.id||b.query.id||void 0,j=!!b.decodedToken&&b.decodedToken,k=_objectSpread({},f),l={_id:i},j&&(m=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(l[m.modelIdLabel]=j._id),"User"!==c.modelName&&(k[m.modelIdLabel]=j._id)),!i){a.next=43;break}if(a.prev=11,n=0<c.fieldsToExclude.length?"-"+c.fieldsToExclude.join(" -"):null,!j){a.next=26;break}return a.next=16,h.findOne(l,null,{lean:!0});case 16:if(o=a.sent,null==o){a.next=22;break}return a.next=20,h.updateOne(l,k,{lean:!0});case 20:a.next=24;break;case 22:return debug.danger("You are not autorized to update this data."),a.abrupt("return",d.status(500).json({error:"You are not autorized to update this data."}));case 24:a.next=28;break;case 26:return a.next=28,h.updateOne({_id:i},f,{lean:!0});case 28:return a.next=30,h.findOne({_id:i},n,{lean:!0});case 30:if(p=a.sent,!e){a.next=34;break}return b[c.modelName.toLowerCase()]=p,a.abrupt("return",e());case 34:return a.abrupt("return",d.status(200).json((0,_defineProperty2["default"])({},c.modelName.toLowerCase(),p)));case 37:a.prev=37,a.t0=a["catch"](11),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 41:a.next=45;break;case 43:debug.danger("Missing required field `id` on `findOne` model. You can provide it on request body or query."),d.status(500).json({error:"Missing required field `id` on `findOne` model. You can provide it on request body or query."});case 45:case"end":return a.stop();}},a,null,[[11,37]])}));return function(){return a.apply(this,arguments)}}()),(0,_defineProperty2["default"])(this,"delete",/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,d){var e,f,g,h,i,j,k,l,m=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(e=2<m.length&&void 0!==m[2]?m[2]:void 0,f=c.Models,g=f[c.modelName],h=b.params.id||b.body.id||b.query.id||void 0,i=!!b.decodedToken&&b.decodedToken,j={_id:h},i&&(k=require("../../../app/Models/".concat(c.modelName)),"User"!==c.modelName&&(j[k.modelIdLabel]=i._id)),!h){a.next=37;break}if(a.prev=8,!i){a.next=23;break}return a.next=12,g.findOne(j,null,{lean:!0});case 12:if(l=a.sent,console.log(g,j),null==l){a.next=19;break}return a.next=17,g.deleteOne(j);case 17:a.next=21;break;case 19:return debug.danger("You are not autorized to delete this data."),a.abrupt("return",d.status(500).json({error:"You are not autorized to delete this data."}));case 21:a.next=25;break;case 23:return a.next=25,g.deleteOne(j);case 25:if(!e){a.next=28;break}return b["delete"]={error:null,message:"".concat(c.modelName," successfully deleted.")},a.abrupt("return",e());case 28:return a.abrupt("return",d.status(200).json({error:null,message:"".concat(c.modelName," successfully deleted.")}));case 31:a.prev=31,a.t0=a["catch"](8),debug.danger(a.t0.message),d.status(500).json({error:"Internal Server Error."});case 35:a.next=39;break;case 37:debug.danger("Missing required field `id` on `findOne` model. You can provide it on request body or query."),d.status(500).json({error:"Missing required field `id` on `findOne` model. You can provide it on request body or query."});case 39:case"end":return a.stop();}},a,null,[[8,31]])}));return function(){return a.apply(this,arguments)}}()),this.modelName=b,this.Model=b?require("../../../app/Models/".concat(this.modelName)):{hash:[],exclude:[]},this.fieldsToHash=this.Model.hash,this.fieldsToExclude=this.Model.exclude,this.Models=Database.get("models")};module.exports=Models;